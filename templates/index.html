<script>
async function fetchTransactions(){
    let resp = await fetch("/get_transactions"); 
    let data = await resp.json();

    document.getElementById("wallet-info").innerText = data.wallet_daily_total;

    // Daily Summary
    let dailyBody = document.querySelector("#daily-summary tbody");
    dailyBody.innerHTML = "";
    data.daily_summary.forEach(d=>{
        let row = dailyBody.insertRow();
        row.insertCell(0).innerText = d.date;
        row.insertCell(1).innerText = d.total;
    });

    // New Orders
    let newBody = document.querySelector("#new-orders-table tbody");
    newBody.innerHTML = "";
    data.new_orders.forEach(tx=>{
        let row = newBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name || "-";
        row.insertCell(4).innerText = tx.time_str || "-";
        row.insertCell(5).innerText = tx.bank || "-";

        let cell = row.insertCell(6);

        // ปุ่มอนุมัติ
        let btnApprove = document.createElement("button");
        btnApprove.className = "approve"; 
        btnApprove.innerText = "อนุมัติ";
        btnApprove.onclick = async ()=>{
            let customer_user = prompt("กรุณาใส่ยูสเซอร์ลูกค้า เช่น thk101982");
            if(!customer_user) return alert("ต้องใส่ยูสเซอร์ลูกค้าก่อนอนุมัติ");

            const nowTime = new Date();
            const nowTimeStr = nowTime.toISOString().slice(0,19).replace("T"," ");

            await fetch("/approve",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id, customer_user: customer_user})
            });

            // อัพเดทเวลาทันทีบนหน้าตาราง
            tx.status = "approved";
            tx.customer_user = customer_user;
            tx.approved_time = nowTimeStr;
            approvedBody = document.querySelector("#approved-orders-table tbody");
            let newRow = approvedBody.insertRow(0);
            newRow.insertCell(0).innerText = tx.id;
            newRow.insertCell(1).innerText = tx.event;
            newRow.insertCell(2).innerText = tx.amount_str;
            newRow.insertCell(3).innerText = tx.name || "-";
            newRow.insertCell(4).innerText = tx.time_str || "-";
            newRow.insertCell(5).innerText = tx.bank || "-";
            newRow.insertCell(6).innerText = "คุณ"; // ถ้าอยากโชว์ชื่อ approver จริง ต้องดึงจาก backend
            newRow.insertCell(7).innerText = tx.approved_time;
            newRow.insertCell(8).innerText = tx.customer_user;
            let restoreBtn = document.createElement("button");
            restoreBtn.className = "restore"; restoreBtn.innerText = "คืนเป็น New";
            restoreBtn.onclick = async ()=>{
                if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;
                await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
                fetchTransactions();
            };
            newRow.insertCell(9).appendChild(restoreBtn);

            // ลบจาก New Orders
            row.remove();
        };

        // ปุ่มยกเลิก
        let btnCancel = document.createElement("button");
        btnCancel.className = "cancel"; 
        btnCancel.innerText = "ยกเลิก";
        btnCancel.onclick = async ()=>{
            const nowTime = new Date();
            const nowTimeStr = nowTime.toISOString().slice(0,19).replace("T"," ");

            await fetch("/cancel",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id})
            });

            // อัพเดทเวลาทันทีบนหน้าตาราง
            tx.status = "cancelled";
            tx.cancelled_time = nowTimeStr;
            cancelledBody = document.querySelector("#cancelled-orders-table tbody");
            let newRow = cancelledBody.insertRow(0);
            newRow.insertCell(0).innerText = tx.id;
            newRow.insertCell(1).innerText = tx.event;
            newRow.insertCell(2).innerText = tx.amount_str;
            newRow.insertCell(3).innerText = tx.name || "-";
            newRow.insertCell(4).innerText = tx.time_str || "-";
            newRow.insertCell(5).innerText = tx.bank || "-";
            newRow.insertCell(6).innerText = "คุณ"; // ชื่อ canceler
            newRow.insertCell(7).innerText = tx.cancelled_time;
            let restoreBtn = document.createElement("button");
            restoreBtn.className = "restore"; restoreBtn.innerText = "คืนเป็น New";
            restoreBtn.onclick = async ()=>{
                if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;
                await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
                fetchTransactions();
            };
            newRow.insertCell(8).appendChild(restoreBtn);

            // ลบจาก New Orders
            row.remove();
        };

        cell.appendChild(btnApprove); 
        cell.appendChild(btnCancel);
    });

    // Approved Orders & Cancelled Orders ตามเดิม
    // ... (ไม่เปลี่ยน)
}

// รีเซทรายการ
async function resetApproved(){
    if(!confirm("คุณแน่ใจว่าจะรีเซทรายการที่อนุมัติทั้งหมด?")) return;
    await fetch("/reset_approved",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}
async function resetCancelled(){
    if(!confirm("คุณแน่ใจว่าจะรีเซทรายการที่ยกเลิกทั้งหมด?")) return;
    await fetch("/reset_cancelled",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}

setInterval(fetchTransactions,3000);
fetchTransactions();
</script>
