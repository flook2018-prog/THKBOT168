<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333}
h1{text-align:center;margin-bottom:20px}
h2{margin:10px 0}
#top-bar{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:20px;gap:10px}
.summary-card{background:#fff;border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);min-width:250px;flex:1}
.summary-card h2{font-size:1.2em;text-align:center;margin-bottom:10px;}
.summary-card span{font-weight:bold;font-size:1.5em;color:#28a745}
#dashboard{display:flex;gap:20px;flex-wrap:wrap}
#left-column,#right-column{flex:1;min-width:300px;display:flex;flex-direction:column;gap:20px}
#bottom-row{margin-top:20px}
.scroll-box{max-height:400px;overflow-y:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:10px;scroll-behavior:smooth}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:center;font-size:0.95em;border-bottom:1px solid #ddd}
th{position:sticky;top:0;background:#f8f9fa;z-index:2}
tr:hover{background-color:#f1f5f9;transition:0.3s}
button{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;transition:0.3s;margin:2px}
button.approve{background:#28a745;color:white}
button.approve:hover{background:#218838}
button.cancel{background:#dc3545;color:white}
button.restore{background:#ffc107;color:#333}
button.restore:hover{background:#e0a800}
#ip-display{position:absolute;top:10px;right:20px;font-weight:bold;color:#555}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0.2);border-radius:4px}
::-webkit-scrollbar-track{background:transparent}
</style>
</head>
<body>
<h1>THKBot168 Dashboard (Realtime)</h1>
<div id="ip-display">IP: {{ user_ip }}</div>

<div id="top-bar">
  <div class="summary-card">
    <h2>üí∞ ‡∏¢‡∏≠‡∏î Wallet ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
    <span id="wallet-info">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
  <div class="summary-card">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
    <table id="daily-summary" style="width:100%;border:none">
      <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏ß‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="summary-card">
    <h2>‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
    <button onclick="resetApproved()">‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
    <button onclick="resetCancelled()">‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<div id="dashboard">
  <div id="left-column">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New Orders)</h2>
    <div class="scroll-box">
      <table id="new-orders-table">
        <thead>
        <tr><th>ID</th><th>Bank</th><th>Name</th><th>Amount</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="right-column">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved)</h2>
    <div class="scroll-box">
      <table id="approved-orders-table">
        <thead>
        <tr><th>ID</th><th>Bank</th><th>Name</th><th>Amount</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled)</h2>
    <div class="scroll-box">
      <table id="cancelled-orders-table">
        <thead>
        <tr><th>ID</th><th>Bank</th><th>Name</th><th>Amount</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function fetchTransactions(){
  const res = await fetch('/get_transactions');
  const data = await res.json();

  document.getElementById('wallet-info').innerText = data.wallet_daily_total;

  // Daily summary
  const dsBody = document.querySelector('#daily-summary tbody');
  dsBody.innerHTML = '';
  data.daily_summary.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.date}</td><td>${d.total}</td>`;
    dsBody.appendChild(tr);
  });

  // New orders
  const newBody = document.querySelector('#new-orders-table tbody');
  newBody.innerHTML = '';
  data.new_orders.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${tx.id}</td><td>${tx.bank}</td><td>${tx.name}</td><td>${tx.amount_str}</td><td>${tx.time_str}</td>
      <td>
        <button class="approve" onclick="approve('${tx.id}')">Approve</button>
        <button class="cancel" onclick="cancel('${tx.id}')">Cancel</button>
      </td>`;
    newBody.appendChild(tr);
  });

  // Approved
  const apBody = document.querySelector('#approved-orders-table tbody');
  apBody.innerHTML = '';
  data.approved_orders.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${tx.id}</td><td>${tx.bank}</td><td>${tx.name}</td><td>${tx.amount_str}</td><td>${tx.approved_time}</td>`;
    apBody.appendChild(tr);
  });

  // Cancelled
  const canBody = document.querySelector('#cancelled-orders-table tbody');
  canBody.innerHTML = '';
  data.cancelled_orders.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${tx.id}</td><td>${tx.bank}</td><td>${tx.name}</td><td>${tx.amount_str}</td><td>${tx.cancelled_time}</td>`;
    canBody.appendChild(tr);
  });
}

async function approve(id){
  const customer_user = prompt("‡πÉ‡∏™‡πà Customer User (‡πÄ‡∏ä‡πà‡∏ô thk101982):");
  if(!customer_user) return;
  await fetch('/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,customer_user})});
  fetchTransactions();
}

async function cancel(id){
  await fetch('/cancel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  fetchTransactions();
}

async function resetApproved(){
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    await fetch('/reset_approved',{method:'POST'});
    fetchTransactions();
  }
}

async function resetCancelled(){
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    await fetch('/reset_cancelled',{method:'POST'});
    fetchTransactions();
  }
}

setInterval(fetchTransactions,2000);
fetchTransactions();
</script>

</body>
</html>
