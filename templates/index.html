<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<style>
body{
    font-family:'Segoe UI',sans-serif;
    background:#f0f2f5;
    margin:0;
    padding:20px;
    color:#333;
}
h1{text-align:center;margin-bottom:20px}
h2{margin:10px 0}

/* Top bar */
#top-bar{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:20px;
    gap:10px;
}
.summary-card{
    background:#fff;
    border-radius:12px;
    padding:15px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    min-width:250px;
    flex:1;
}
.summary-card h2{font-size:1.2em;text-align:center;margin-bottom:10px;}
.summary-card span{font-weight:bold;font-size:1.5em;color:#28a745;}

/* Dashboard layout */
#dashboard{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
}

/* Left and Right columns */
#left-column,#right-column{
    flex:1;
    min-width:300px;
    display:flex;
    flex-direction:column;
    gap:20px;
}

/* Bottom full-width */
#bottom-row{
    width:100%;
}

/* Table style */
.scroll-box{
    max-height:400px;
    overflow-y:auto;
    background:#fff;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    padding:10px;
}
table{
    width:100%;
    border-collapse:collapse;
}
th,td{
    padding:10px;
    text-align:center;
}
th{
    position:sticky;
    top:0;
    background:linear-gradient(90deg,#4a90e2,#007bff);
    color:white;
}

/* Zebra stripe + subtle gradient per row */
tr.new:nth-child(even){background:linear-gradient(to right, #eaf6ff 0%, #f0faff 100%)}
tr.new:nth-child(odd){background:#eaf6ff}
tr.cancelled:nth-child(even){background:linear-gradient(to right, #fff5f5 0%, #fffafa 100%)}
tr.cancelled:nth-child(odd){background:#fff5f5}

/* Hover ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ very light */
tr:hover{background-color:#f5f5f5;transition:0.3s}

/* Buttons */
button{
    padding:6px 12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    margin:2px;
}
button.approve{background:#28a745;color:white}
button.approve:hover{background:#218838}
button.cancel{background:#ffc107;color:white}
button.cancel:hover{background:#e0a800}
button.restore{background:#dc3545;color:white}
button.restore:hover{background:#c82333}

/* Scrollbar */
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0.2);border-radius:4px}
::-webkit-scrollbar-track{background:transparent}

/* Responsive */
@media(max-width:900px){
    #dashboard{flex-direction:column;}
    #left-column,#right-column{width:100%;}
}
</style>
</head>
<body>
<h1>THKBot168 Dashboard (Realtime)</h1>

<div id="top-bar">
    <div class="summary-card">
        <h2>üí∞ Wallet ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <span id="wallet-info">0</span> ‡∏ö‡∏≤‡∏ó
        <button id="refresh-btn" onclick="fetchTransactions()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
    <div class="summary-card">
        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
        <table id="daily-summary-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏¢‡∏≠‡∏î</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="dashboard">
    <div id="left-column">
        <div class="scroll-box">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New Orders)</h2>
            <table id="new-orders-table">
                <thead><tr>
                    <th>TX ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="right-column">
        <div class="scroll-box">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved Orders)</h2>
            <table id="approved-orders-table">
                <thead><tr>
                    <th>TX ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th>
                </tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="bottom-row" class="scroll-box">
        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled Orders)</h2>
        <table id="cancelled-orders-table">
            <thead><tr>
                <th>TX ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏ß‡∏•‡∏≤ Cancel</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
async function fetchTransactions(){
    let resp = await fetch("/get_transactions");
    let data = await resp.json();
    document.getElementById("wallet-info").innerText = data.wallet_daily_total;

    // ‡∏´‡∏≤ max amount ‡∏Ç‡∏≠‡∏á Approved Orders
    let approvedAmounts = data.approved_orders.map(tx=>parseFloat(tx.amount));
    let maxAmount = Math.max(...approvedAmounts, 1);

    function buildRow(tableBody, tx, status){
        let row = tableBody.insertRow();
        row.className = status;
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name;
        row.insertCell(4).innerText = tx.time_str;
        row.insertCell(5).innerText = tx.bank;

        // Gradient ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Approved Orders)
        if(status=="approved"){
            let percent = parseFloat(tx.amount)/maxAmount;
            let startColor = [230, 255, 230];
            let endColor = [102, 255, 102];
            let r = Math.round(startColor[0] + (endColor[0]-startColor[0])*percent);
            let g = Math.round(startColor[1] + (endColor[1]-startColor[1])*percent);
            let b = Math.round(startColor[2] + (endColor[2]-startColor[2])*percent);
            row.style.background = `linear-gradient(to right, rgb(${r},${g},${b}) 0%, rgb(${r},${g},${b}) 100%)`;
        }

        if(status=="new"){
            let cell = row.insertCell(6);
            let btnApprove=document.createElement("button");
            btnApprove.className="approve"; btnApprove.innerText="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
            btnApprove.onclick = async ()=>{
                let customer_user=prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô thk101982");
                if(!customer_user) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
                await fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id,customer_user:customer_user})});
                fetchTransactions();
            };
            let btnCancel=document.createElement("button");
            btnCancel.className="cancel"; btnCancel.innerText="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
            btnCancel.onclick=async ()=>{
                await fetch("/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
                fetchTransactions();
            };
            cell.appendChild(btnApprove); cell.appendChild(btnCancel);
        }else{
            let lastCell = row.insertCell(status=="approved"?9:7);
            let restoreBtn = document.createElement("button");
            restoreBtn.className="restore"; restoreBtn.innerText="‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New";
            restoreBtn.onclick = async ()=>{
                if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô New?")) return;
                await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
                fetchTransactions();
            };
            lastCell.appendChild(restoreBtn);
        }
        return row;
    }

    let newBody=document.querySelector("#new-orders-table tbody"); newBody.innerHTML="";
    data.new_orders.forEach(tx=>buildRow(newBody,tx,"new"));

    let approvedBody=document.querySelector("#approved-orders-table tbody"); approvedBody.innerHTML="";
    data.approved_orders.forEach(tx=>buildRow(approvedBody,tx,"approved"));

    let cancelledBody=document.querySelector("#cancelled-orders-table tbody"); cancelledBody.innerHTML="";
    data.cancelled_orders.forEach(tx=>buildRow(cancelledBody,tx,"cancelled"));

    let dailyBody=document.querySelector("#daily-summary-table tbody"); dailyBody.innerHTML="";
    data.daily_summary.forEach(d=>{
        let row=dailyBody.insertRow();
        row.insertCell(0).innerText=d.date;
        row.insertCell(1).innerText=d.total;
    });
}
setInterval(fetchTransactions,3000);
fetchTransactions();
</script>
</body>
</html>
