<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333}
h1,h2{text-align:center;margin-bottom:15px}
h2 span{font-weight:bold;font-size:1.3em}
.scroll-box{max-height:400px;overflow-y:auto;margin-bottom:25px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:10px;scroll-behavior:smooth}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;text-align:center;font-size:1em}
th{position:sticky;top:0;z-index:2;background:linear-gradient(90deg,#4a90e2,#007bff);color:white;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
tr:hover{background-color:#f1f5f9;transition:0.3s}
button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;transition:0.3s;margin:2px}
button:hover{transform:scale(1.05)}
button.approve{background:#28a745;color:white}
button.approve:hover{background:#218838}
button.cancel{background:#ffc107;color:white}
button.cancel:hover{background:#e0a800}
button.restore{background:#dc3545;color:white}
button.restore:hover{background:#c82333}
#ip-display{position:absolute;top:10px;right:20px;font-weight:bold;color:#555}
#wallet-info{font-size:2em;font-weight:bold;color:#28a745;margin-left:10px}
#refresh-btn{padding:6px 12px;border-radius:6px;background:#007bff;color:white;cursor:pointer;float:right;margin-top:-50px;margin-right:20px}
#refresh-btn:hover{background:#0056b3}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0.2);border-radius:4px}
::-webkit-scrollbar-track{background:transparent}
</style>
</head>
<body>
<h1>THKBot168 Dashboard (Realtime)</h1>
<div id="ip-display">IP: {{ user_ip }}</div>

<h2>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤: <span id="current-datetime"></span></h2>
<h2>üí∞ ‡∏¢‡∏≠‡∏î Wallet ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="wallet-info">0</span> ‡∏ö‡∏≤‡∏ó
<button id="refresh-btn" onclick="fetchTransactions()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h2>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New Orders)</h2>
<div class="scroll-box">
<table id="new-orders-table">
<thead><tr>
<th>Transaction ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved Orders)</h2>
<div class="scroll-box">
<table id="approved-orders-table">
<thead><tr>
<th>Transaction ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
<th>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled Orders)</h2>
<div class="scroll-box">
<table id="cancelled-orders-table">
<thead><tr>
<th>Transaction ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
<th>‡πÄ‡∏ß‡∏•‡∏≤ Cancel</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
<div class="scroll-box">
<table id="daily-summary-table">
<thead><tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<script>
function updateCurrentTime(){
    document.getElementById("current-datetime").innerText = new Date().toLocaleString('en-GB',{hour12:false})
}
setInterval(updateCurrentTime,1000); updateCurrentTime();

async function fetchTransactions(){
    let resp = await fetch("/get_transactions");
    let data = await resp.json();

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î Wallet ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    document.getElementById("wallet-info").innerText = data.wallet_daily_total;

    // --- New Orders ---
    let newBody = document.querySelector("#new-orders-table tbody"); 
    newBody.innerHTML = "";
    data.new_orders.forEach(tx => {
        let row = newBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name;
        row.insertCell(4).innerText = tx.time_str;
        row.insertCell(5).innerText = tx.bank;

        let cell = row.insertCell(6);
        // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        let btnApprove = document.createElement("button");
        btnApprove.innerText = "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
        btnApprove.className = "approve";
        btnApprove.onclick = async () => {
            let customer_user = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô thk101982");
            if(!customer_user) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
            await fetch("/approve",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id,customer_user:customer_user})
            });
            fetchTransactions();
        };

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        let btnCancel = document.createElement("button");
        btnCancel.innerText = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        btnCancel.className = "cancel";
        btnCancel.onclick = async () => {
            await fetch("/cancel",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id})
            });
            fetchTransactions();
        };

        cell.appendChild(btnApprove); 
        cell.appendChild(btnCancel);
    });

    // --- Approved Orders ---
    let approvedBody = document.querySelector("#approved-orders-table tbody"); 
    approvedBody.innerHTML = "";
    data.approved_orders.forEach(tx => {
        let row = approvedBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name;
        row.insertCell(4).innerText = tx.time_str;
        row.insertCell(5).innerText = tx.bank;
        row.insertCell(6).innerText = tx.approver_name;
        row.insertCell(7).innerText = tx.approved_time;
        row.insertCell(8).innerText = tx.customer_user||"-";

        let restoreBtn = document.createElement("button");
        restoreBtn.innerText = "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New";
        restoreBtn.className = "restore";
        restoreBtn.onclick = async () => {
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô New?")) return;
            await fetch("/restore",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id})
            });
            fetchTransactions();
        };
        row.insertCell(9).appendChild(restoreBtn);
    });

    // --- Cancelled Orders ---
    let cancelledBody = document.querySelector("#cancelled-orders-table tbody"); 
    cancelledBody.innerHTML = "";
    data.cancelled_orders.forEach(tx => {
        let row = cancelledBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name;
        row.insertCell(4).innerText = tx.time_str;
        row.insertCell(5).innerText = tx.bank;
        row.insertCell(6).innerText = tx.cancelled_time;

        let restoreBtn = document.createElement("button");
        restoreBtn.innerText = "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New";
        restoreBtn.className = "restore";
        restoreBtn.onclick = async () => {
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô New?")) return;
            await fetch("/restore",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({id:tx.id})
            });
            fetchTransactions();
        };
        row.insertCell(7).appendChild(restoreBtn);
    });

    // --- Daily Summary Table ---
    let dailyBody = document.querySelector("#daily-summary-table tbody");
    dailyBody.innerHTML = "";
    data.daily_summary.forEach(d => {
        let row = dailyBody.insertRow();
        row.insertCell(0).innerText = d.date;
        row.insertCell(1).innerText = d.total;
    });
}
setInterval(fetchTransactions,3000);
fetchTransactions();
</script>
</body>
</html>
