<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333}
h1{text-align:center;margin-bottom:20px}
table{width:100%;border-collapse:collapse;margin-bottom:20px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#eee}
button{padding:4px 8px;margin:2px;cursor:pointer}
.approve{background:#4CAF50;color:white;border:none}
.cancel{background:#f44336;color:white;border:none}
.restore{background:#008CBA;color:white;border:none}
</style>
</head>
<body>

<h1>THKBot168 Dashboard</h1>
<p>IP ของคุณ: <span id="user-ip">{{ user_ip }}</span></p>
<p>ยอดรวมวันนี้: <span id="wallet-info">0.00</span> บาท</p>

<h2>New Orders</h2>
<table id="new-orders-table">
<thead>
<tr>
<th>ID</th><th>ประเภท</th><th>จำนวน</th><th>ชื่อ/เบอร์</th><th>เวลา</th><th>ธนาคาร</th><th>จัดการ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>Approved Orders</h2>
<table id="approved-orders-table">
<thead>
<tr>
<th>ID</th><th>ประเภท</th><th>จำนวน</th><th>ชื่อ/เบอร์</th><th>เวลา</th><th>ธนาคาร</th><th>ผู้อนุมัติ</th><th>เวลาอนุมัติ</th><th>ลูกค้า</th><th>จัดการ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>Cancelled Orders</h2>
<table id="cancelled-orders-table">
<thead>
<tr>
<th>ID</th><th>ประเภท</th><th>จำนวน</th><th>ชื่อ/เบอร์</th><th>เวลา</th><th>ธนาคาร</th><th>ผู้ยกเลิก</th><th>เวลายกเลิก</th><th>จัดการ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>สรุปยอดรายวัน</h2>
<table id="daily-summary">
<thead>
<tr><th>วันที่</th><th>ยอดรวม</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
async function fetchTransactions(){
    let resp = await fetch("/get_transactions");
    let data = await resp.json();

    document.getElementById("wallet-info").innerText = data.wallet_daily_total;

    // สรุปยอดรายวัน
    let dailyBody = document.querySelector("#daily-summary tbody");
    dailyBody.innerHTML = "";
    data.daily_summary.forEach(d=>{
        let row = dailyBody.insertRow();
        row.insertCell(0).innerText = d.date;
        row.insertCell(1).innerText = d.total;
    });

    // ฟังก์ชันเพิ่มปุ่มดูสลิป
    function addSlipButton(cell, tx){
        if(tx.slip_filename){
            let viewBtn = document.createElement("button");
            viewBtn.className = "restore";
            viewBtn.innerText = "ดูสลิป";
            viewBtn.onclick = () => window.open(`/slip/${tx.slip_filename}`,"_blank");
            cell.appendChild(viewBtn);
        }
    }

    // New Orders
    let newBody = document.querySelector("#new-orders-table tbody");
    newBody.innerHTML = "";
    data.new_orders.forEach(tx=>{
        let row = newBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name || "-";
        row.insertCell(4).innerText = tx.time_str || "-";
        row.insertCell(5).innerText = tx.bank || "-";

        let cell = row.insertCell(6);
        let btnApprove = document.createElement("button");
        btnApprove.className = "approve"; btnApprove.innerText = "อนุมัติ";
        btnApprove.onclick = async ()=>{
            let customer_user = prompt("กรุณาใส่ยูสเซอร์ลูกค้า เช่น thk101982");
            if(!customer_user) return alert("ต้องใส่ยูสเซอร์ลูกค้าก่อนอนุมัติ");
            await fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id,customer_user})});
            fetchTransactions();
        };
        let btnCancel = document.createElement("button");
        btnCancel.className = "cancel"; btnCancel.innerText = "ยกเลิก";
        btnCancel.onclick = async ()=>{
            await fetch("/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        cell.appendChild(btnApprove);
        cell.appendChild(btnCancel);
        addSlipButton(cell, tx);
    });

    // Approved Orders
    let approvedBody = document.querySelector("#approved-orders-table tbody");
    approvedBody.innerHTML = "";
    data.approved_orders.forEach(tx=>{
        let row = approvedBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name || "-";
        row.insertCell(4).innerText = tx.time_str || "-";
        row.insertCell(5).innerText = tx.bank || "-";
        row.insertCell(6).innerText = tx.approver_name || "-";
        row.insertCell(7).innerText = tx.approved_time_str || "-";
        row.insertCell(8).innerText = tx.customer_user || "-";

        let cell = row.insertCell(9);
        let restoreBtn = document.createElement("button");
        restoreBtn.className = "restore"; restoreBtn.innerText = "คืนเป็น New";
        restoreBtn.onclick = async ()=>{
            if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;
            await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        cell.appendChild(restoreBtn);
        addSlipButton(cell, tx);
    });

    // Cancelled Orders
    let cancelledBody = document.querySelector("#cancelled-orders-table tbody");
    cancelledBody.innerHTML = "";
    data.cancelled_orders.forEach(tx=>{
        let row = cancelledBody.insertRow();
        row.insertCell(0).innerText = tx.id;
        row.insertCell(1).innerText = tx.event;
        row.insertCell(2).innerText = tx.amount_str;
        row.insertCell(3).innerText = tx.name || "-";
        row.insertCell(4).innerText = tx.time_str || "-";
        row.insertCell(5).innerText = tx.bank || "-";
        row.insertCell(6).innerText = tx.canceler_name || "-";
        row.insertCell(7).innerText = tx.cancelled_time_str || "-";

        let cell = row.insertCell(8);
        let restoreBtn = document.createElement("button");
        restoreBtn.className = "restore"; restoreBtn.innerText = "คืนเป็น New";
        restoreBtn.onclick = async ()=>{
            if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;
            await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        cell.appendChild(restoreBtn);
        addSlipButton(cell, tx);
    });
}

setInterval(fetchTransactions,3000);
fetchTransactions();
</script>

</body>
</html>
