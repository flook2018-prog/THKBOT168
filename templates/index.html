<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333}
h1{text-align:center;margin-bottom:20px}
h2{margin:10px 0}
table{width:100%;border-collapse:collapse;margin-bottom:20px}
th,td{border:1px solid #ccc;padding:8px;text-align:left}
th{background:#eee}
.section{background:#fff;padding:15px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
</style>
</head>
<body>
<h1>THKBot168 Dashboard</h1>

<div class="section">
    <h2>รายการใหม่</h2>
    <table>
        <thead>
            <tr>
                <th>เวลา</th><th>ID</th><th>Event</th><th>จำนวนเงิน</th><th>ชื่อ/เบอร์</th><th>ธนาคาร</th><th>สถานะ</th>
            </tr>
        </thead>
        <tbody id="newOrders"></tbody>
    </table>
</div>

<div class="section">
    <h2>รายการที่อนุมัติแล้ว</h2>
    <table>
        <thead>
            <tr>
                <th>เวลา</th><th>ID</th><th>Event</th><th>จำนวนเงิน</th><th>ชื่อ/เบอร์</th><th>ธนาคาร</th><th>สถานะ</th><th>เวลาอนุมัติ</th><th>ผู้อนุมัติ</th>
            </tr>
        </thead>
        <tbody id="approvedOrders"></tbody>
    </table>
</div>

<div class="section">
    <h2>รายการที่ยกเลิก</h2>
    <table>
        <thead>
            <tr>
                <th>เวลา</th><th>ID</th><th>Event</th><th>จำนวนเงิน</th><th>ชื่อ/เบอร์</th><th>ธนาคาร</th><th>สถานะ</th><th>เวลายกเลิก</th><th>ผู้ยกเลิก</th>
            </tr>
        </thead>
        <tbody id="cancelledOrders"></tbody>
    </table>
</div>

<script>
async function fetchTransactions(){
    const res = await fetch('/get_transactions');
    const data = await res.json();

    const newOrders = document.getElementById('newOrders');
    const approvedOrders = document.getElementById('approvedOrders');
    const cancelledOrders = document.getElementById('cancelledOrders');

    function renderRow(tx, type){
        // เวลา -7 ชั่วโมง
        let time = new Date(tx.time).getTime();
        time = new Date(time - (7*60*60*1000));
        let timeStr = time.toISOString().slice(0,19).replace('T',' ');

        let row = `<tr>
            <td>${timeStr}</td>
            <td>${tx.id}</td>
            <td>${tx.event}</td>
            <td>${(tx.amount/100).toFixed(2)}</td>
            <td>${tx.name}</td>
            <td>${tx.bank}</td>
            <td>${tx.status}</td>`;

        if(type==="approved"){
            let approvedTime = tx.approved_time ? new Date(new Date(tx.approved_time).getTime() - (7*60*60*1000)) : null;
            let approvedTimeStr = approvedTime ? approvedTime.toISOString().slice(0,19).replace('T',' ') : "-";
            row += `<td>${approvedTimeStr}</td><td>${tx.approver_name||"-"}</td>`;
        }
        if(type==="cancelled"){
            let cancelledTime = tx.cancelled_time ? new Date(new Date(tx.cancelled_time).getTime() - (7*60*60*1000)) : null;
            let cancelledTimeStr = cancelledTime ? cancelledTime.toISOString().slice(0,19).replace('T',' ') : "-";
            row += `<td>${cancelledTimeStr}</td><td>${tx.canceler_name||"-"}</td>`;
        }

        row += `</tr>`;
        return row;
    }

    newOrders.innerHTML = data.new_orders.map(tx=>renderRow(tx,"new")).join("");
    approvedOrders.innerHTML = data.approved_orders.map(tx=>renderRow(tx,"approved")).join("");
    cancelledOrders.innerHTML = data.cancelled_orders.map(tx=>renderRow(tx,"cancelled")).join("");
}

setInterval(fetchTransactions,3000);
fetchTransactions();
</script>
</body>
</html>
