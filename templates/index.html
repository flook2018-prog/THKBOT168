<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<style>
/* --- ‡πÉ‡∏ä‡πâ style ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333}
h1{text-align:center;margin-bottom:20px}
h2{margin:10px 0}
#top-bar{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:20px;gap:10px}
.summary-card{background:#fff;border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);min-width:250px;flex:1}
.summary-card h2{font-size:1.2em;text-align:center;margin-bottom:10px;}
.summary-card span{font-weight:bold;font-size:1.5em;color:#28a745}
#dashboard{display:flex;gap:20px;flex-wrap:wrap}
#left-column,#right-column{flex:1;min-width:300px;display:flex;flex-direction:column;gap:20px}
#bottom-row{margin-top:20px}
.scroll-box{max-height:400px;overflow-y:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:10px;scroll-behavior:smooth}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:center;font-size:0.95em;border-bottom:1px solid #ddd}
th{position:sticky;top:0;background:#f8f9fa;z-index:2}
tr:hover{background-color:#f1f5f9;transition:0.3s}
button{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;transition:0.3s;margin:2px}
button.approve{background:#28a745;color:white}
button.approve:hover{background:#218838}
button.cancel{background:#dc3545;color:white}
button.restore{background:#ffc107;color:#333}
button.restore:hover{background:#e0a800}
#ip-display{position:absolute;top:10px;right:20px;font-weight:bold;color:#555}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0.2);border-radius:4px}
::-webkit-scrollbar-track{background:transparent}
</style>
</head>
<body>
<h1>THKBot168 Dashboard (Realtime)</h1>
<div id="ip-display">IP: {{ user_ip }}</div>

<div id="top-bar">
  <div class="summary-card">
    <h2>üí∞ ‡∏¢‡∏≠‡∏î Wallet ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
    <span id="wallet-info">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
  <div class="summary-card">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
    <table id="daily-summary" style="width:100%;border:none">
      <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏ß‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="summary-card">
    <h2>Top 5 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô (‡∏ù‡∏≤‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</h2>
    <canvas id="top5-chart" width="400" height="150"></canvas>
  </div>
  <div class="summary-card">
    <h2>‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
    <button onclick="resetApproved()">‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
    <button onclick="resetCancelled()">‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<div id="dashboard">
  <div id="left-column">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New Orders)</h2>
    <div class="scroll-box">
      <table id="new-orders-table">
        <thead>
        <tr><th>ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏™‡∏•‡∏¥‡∏õ</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="right-column">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Approved Orders)</h2>
    <div class="scroll-box">
      <table id="approved-orders-table">
        <thead>
        <tr><th>ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏•‡∏¥‡∏õ</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="bottom-row">
  <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Cancelled Orders)</h2>
  <div class="scroll-box">
    <table id="cancelled-orders-table">
      <thead>
      <tr><th>ID</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th>
      <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th><th>‡πÄ‡∏ß‡∏•‡∏≤ Cancel</th><th>‡∏™‡∏•‡∏¥‡∏õ</th><th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let top5Chart=null;

async function fetchTransactions(){
    let resp=await fetch("/get_transactions"); 
    let data=await resp.json();

    document.getElementById("wallet-info").innerText = data.wallet_daily_total;

    let dailyBody = document.querySelector("#daily-summary tbody");
    dailyBody.innerHTML="";
    data.daily_summary.forEach(d=>{
        let row = dailyBody.insertRow();
        row.insertCell(0).innerText=d.date;
        row.insertCell(1).innerText=d.total;
    });

    function renderSlip(tx){
        if(tx.slip_filename){
            return `<a href="/slip/${tx.slip_filename}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ</a>`;
        } else {
            return `<input type="file" onchange="uploadSlip(event,'${tx.id}')">`;
        }
    }

    let newBody = document.querySelector("#new-orders-table tbody");
    newBody.innerHTML="";
    data.new_orders.forEach(tx=>{
        let row=newBody.insertRow();
        row.insertCell(0).innerText=tx.id;
        row.insertCell(1).innerText=tx.event;
        row.insertCell(2).innerText=tx.amount_str;
        row.insertCell(3).innerText=tx.name || "-";
        row.insertCell(4).innerText=tx.time_str || "-";
        row.insertCell(5).innerText=tx.bank || "-";
        row.insertCell(6).innerHTML=renderSlip(tx);

        let cell=row.insertCell(7);
        let btnApprove=document.createElement("button");
        btnApprove.className="approve"; btnApprove.innerText="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
        btnApprove.onclick=async ()=>{
            let customer_user=prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô thk101982");
            if(!customer_user) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
            await fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id,customer_user:customer_user})});
            fetchTransactions();
        };
        let btnCancel=document.createElement("button");
        btnCancel.className="cancel"; btnCancel.innerText="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        btnCancel.onclick=async ()=>{
            await fetch("/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        cell.appendChild(btnApprove); cell.appendChild(btnCancel);
    });

    let approvedBody=document.querySelector("#approved-orders-table tbody");
    approvedBody.innerHTML="";
    data.approved_orders.forEach(tx=>{
        let row=approvedBody.insertRow();
        row.insertCell(0).innerText=tx.id;
        row.insertCell(1).innerText=tx.event;
        row.insertCell(2).innerText=tx.amount_str;
        row.insertCell(3).innerText=tx.name || "-";
        row.insertCell(4).innerText=tx.time_str || "-";
        row.insertCell(5).innerText=tx.bank || "-";
        row.insertCell(6).innerText=tx.approver_name || "-";
        row.insertCell(7).innerText=tx.approved_time_str || "-";
        row.insertCell(8).innerText=tx.customer_user || "-";
        row.insertCell(9).innerHTML=tx.slip_filename ? `<a href="/slip/${tx.slip_filename}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ</a>` : "-";

        let restoreBtn=document.createElement("button");
        restoreBtn.className="restore"; restoreBtn.innerText="‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New";
        restoreBtn.onclick=async ()=>{
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô New?")) return;
            await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        row.insertCell(10).appendChild(restoreBtn);
    });

    let cancelledBody=document.querySelector("#cancelled-orders-table tbody");
    cancelledBody.innerHTML="";
    data.cancelled_orders.forEach(tx=>{
        let row=cancelledBody.insertRow();
        row.insertCell(0).innerText=tx.id;
        row.insertCell(1).innerText=tx.event;
        row.insertCell(2).innerText=tx.amount_str;
        row.insertCell(3).innerText=tx.name || "-";
        row.insertCell(4).innerText=tx.time_str || "-";
        row.insertCell(5).innerText=tx.bank || "-";
        row.insertCell(6).innerText=tx.canceler_name || "-";
        row.insertCell(7).innerText=tx.cancelled_time_str || "-";
        row.insertCell(8).innerHTML=tx.slip_filename ? `<a href="/slip/${tx.slip_filename}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ</a>` : "-";

        let restoreBtn=document.createElement("button");
        restoreBtn.className="restore"; restoreBtn.innerText="‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô New";
        restoreBtn.onclick=async ()=>{
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô New?")) return;
            await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
            fetchTransactions();
        };
        row.insertCell(9).appendChild(restoreBtn);
    });

    // ------------------ Top5 Chart ------------------
    let top5Data = data.top5_summary;
    let ctx = document.getElementById("top5-chart").getContext("2d");
    let labels = Object.keys(top5Data).sort();
    let datasets=[];
    labels.forEach(day=>{
        top5Data[day].forEach((d,i)=>{
            if(!datasets[i]) datasets[i]={label:d.user,data:[],backgroundColor:'rgba(40,167,69,0.6)'};
            datasets[i].data.push(d.amount/100);
        });
    });
    if(top5Chart) top5Chart.destroy();
    top5Chart = new Chart(ctx,{
        type:'bar',
        data:{labels:labels,datasets:datasets},
        options:{indexAxis:'y',responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{title:{display:true,text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)'}},y:{title:{display:true,text:'‡∏ß‡∏±‡∏ô'}}}}
    });
}

async function uploadSlip(event, txid){
    const file = event.target.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append("file", file);
    await fetch(`/upload_slip/${txid}`, {method:"POST", body:formData});
    fetchTransactions();
}

async function resetApproved(){
    if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
    await fetch("/reset_approved",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}
async function resetCancelled(){
    if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
    await fetch("/reset_cancelled",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}

setInterval(fetchTransactions,3000);
fetchTransactions();
</script>
</body>
</html>
